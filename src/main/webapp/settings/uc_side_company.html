<style type="text/css">
  div#rMenu {position:absolute; visibility:hidden; top:0;width:150px; text-align: left;padding: 2px;}
  div#rMenu ul li{
    margin: 5px 0;
    padding: 0 15px;
    cursor: pointer;
    list-style: none outside none;
  }
</style>
<script type="text/javascript">
var rMenu;
var id;
var node;
var setting = {
  view: {
    showIcon: false,
    addDiyDom: addDiyDom,
    showLine:false,
    dblClickExpand: false,
  },
  data: {
    simpleData: {
      enable: true
    }
  },
  callback: {
    onRightClick: OnRightClick,
    onClick: onClick
  }
};

YW.ajax({
  type: 'POST',
  url: '/c/dept/getDeptTree?cid=$${cid}',
  data:'',
  mysuccess: function(data){
      var result=JSON.parse(data);
      $.fn.zTree.init($("#treeDemo"), setting, result.result);
      rMenu = $("#rMenu");
  }
});

function onClick(event, treeId, treeNode, clickFlag) {
  node = treeNode;
  console.log(clickFlag);
  if(clickFlag!=null){
    var treeObj = $.fn.zTree.getZTreeObj(treeId);
    treeObj.expandNode(treeNode);
  }
  
  $('#cid').val("");
  $('#did').val("");
  if(treeNode.type=="comp"){
    $('#cid').val(treeNode.id);
  }else if(treeNode.type=="dept"){
    $('#did').val(treeNode.id);
  }else{
    return;
  }
  doSearch();
} 

//add new node to current selected node
function addNode(data){
  var newNodeData = JSON.parse(data);
  var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
  if(newNodeData.type=="comp"){
    getSider('');
  }else{
    treeObj.addNodes(node, newNodeData);
  }
}

function updateNode(namea){
  node.name= namea;
  var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
  treeObj.updateNode(node);
}

function OnRightClick(event, treeId, treeNode) {
  var treeObj = $.fn.zTree.getZTreeObj(treeId);
  treeObj.selectNode(treeNode);
  onClick(event, treeId, treeNode,null);
  if(event.target.tagName!='SPAN'){
    return;
  }
  id = treeNode.id;
  // blockAlert(event.target.offsetTop);
  showRMenu(treeNode.type, event.clientX, event.target.parentElement.parentElement.offsetTop+10);
  // showRMenu(treeNode.type, event.clientX, event.clientY);
}
function showRMenu(type, x, y) {
  $("#rMenu a").show();
  if(type!="comp"){
    $('#m_add_group').hide();
    $('#m_add_dept').hide();
  }
  if(type=="comp"){
    $('#m_del_group').hide();
    $('#m_del_dept').hide();
    $('#m_edit_group').hide();
    $('#m_edit_dept').hide();
  }
  if(type!="dept"){
    $('#m_move_to').hide();
  }
  if(type=="dept"){
    $('#m_del_group').hide();
    $('#m_edit_group').hide();
    $('#m_edit_comp').hide();
  }
  if(type=="group"){
    $('#m_list_records').hide();
    $('#m_list_genjin').hide();
    $('#m_add_user').hide();
    $('#m_del_dept').hide();
    $('#m_edit_dept').hide();
  }
  rMenu.css({"top":y+"px", "left":x+"px", "visibility":"visible"});
  $("body").bind("mousedown", onBodyMouseDown);
}
function hideRMenu() {
      if (rMenu) rMenu.css({"visibility": "hidden"});
      $("body").unbind("mousedown", onBodyMouseDown);
    }
function onBodyMouseDown(event){
    rMenu.css({"visibility" : "hidden"});
}

function addDiyDom(treeId, treeNode) {
  if(treeNode.type!="group"){
    $("#" + treeNode.tId + "_ico").remove();  
  }
  
  var aObj = $("#" + treeNode.tId + "_a");
  aObj.css('display','inline');
  console.log(treeNode.cnum);
  if(treeNode.cnum!=null){
    var cnumStr = "<span >"+ treeNode.cnum +" </span>";
    aObj.prepend(cnumStr);  
  }
  var color="icon_sh";
  if(treeNode.sh==0 || treeNode.sh==undefined){
    color="icon_wsh";
  }
  if(treeNode.type!="group"){
    var lockStr = '<span id="'+treeNode.tId+'_sh_a" onClick="shenhe(\''+treeNode.tId+'\')" class="icon iconfont '+color+'">&#xe64e;</span>';
    aObj.after(lockStr);
  }
}

function shenhe(id){
  var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
  var treeNode = treeObj.getNodeByTId(id);
  var str = "确定要开通["+treeNode.name+"]吗?";
  if(treeNode.sh==1){
    str = "确定要锁定["+treeNode.name+"]吗?";
  }
  art.dialog.confirm(str, function () {
    YW.ajax({
      type: 'POST',
      url: '/c/dept/toggleShenhe?id='+treeNode.id,
      mysuccess: function(data){
         if(treeNode.sh==1){
            //开通-->锁定
            treeNode.sh=0;
            $("#"+id+"_sh_a").css('color','red');
          }else{
            //锁定--开通
            treeNode.sh=1;
            $("#"+id+"_sh_a").css('color','green');
          }
      }
    });
      
  },function(){
    //cancel
  },'warning');
}
</script>

<script type="text/javascript">
function updateGroup(val){
  YW.ajax({
    type: 'POST',
    url: '/c/dept/group/updateName',
    data:'name='+val+'&id='+node.id,
    mysuccess: function(data){
        alert('修改成功');
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
        node.name =val;
        treeObj.updateNode(node);
    }
  });
}

function updateDept(){
  if(node.type=='comp'){
    art.dialog.open('/v/settings/uc_index_c_edit.html?cid='+node.id);
  }else{
    art.dialog.open('/v/settings/uc_index_d_edit.html?cid='+node.id);
  }
}

function moveTo(targetId){
  console.log('move node...');
  var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
  var target = treeObj.getNodeByParam("id",targetId,null);
  treeObj.moveNode(target,node,"inner",false);
}
function delNode(){
  if(node.type=='group'){
    YW.ajax({
      type: 'POST',
      url: '/c/dept/group/delete',
      data:'id='+node.id,
      mysuccess: function(data){
          var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
          treeObj.removeNode(node);
          alert('成功删除分组: '+node.name);
      }
    });
  }else{
    YW.ajax({
      type: 'POST',
      url: '/c/dept/delete',
      data:'deptId='+node.id,
      mysuccess: function(data){
          var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
          treeObj.removeNode(node);
          alert('成功删除分公司: '+node.name);
      }
    });
  }
}

$(document).ready(function() {
    $('[data-toggle=tooltip]').tooltip();
    $('.sideCont').on('click', '.btns', function(event) {
        event.preventDefault();
        /* Act on the event */
        var Thi=$(this),
        ThiType=Thi.data('type');
        if(ThiType=='add_company'){
            art.dialog.open('/v/settings/uc_index_c_add.html');
        }else if(ThiType=='popover'){
            var popoverTime=setTimeout(function(){
                $('.input_search').focus();
                clearTimeout(popoverTime);
            },100)
        }
        return false;
    });
    $('#rMenu').on('click', 'a', function(event) {
        var Thi=$(this),
        ThiUl=Thi.parents('ul'),
        ThiLi=Thi.parents('li'),
        ThiUrl=Thi.attr('href'),
        ThiType=Thi.data('type');
        if(ThiType=='seeRecords'){
              if(node.type=='comp'){
                art.dialog.open('/v/settings/sys_record.html?cid='+node.id,{
                    padding:0,
                    resize:true,
                    lock:1,
                    height:700,
                    width:1000
                  });
                }else{
                  art.dialog.open('/v/settings/sys_record.html?did='+node.id,{
                    padding:0,
                    resize:true,
                    lock:1,
                    height:700,
                    width:1000
                  });
                }
            return false;
        }else if(ThiType=='seeGenjin'){
          var url="";
          if(node.type=='comp'){
              url = '/v/settings/genjin.html?cid='+node.id;
          }else{
            url = '/v/settings/genjin.html?did='+node.id;
          }
          art.dialog.open(url,{
            padding:0,
            resize:true,
            lock:1,
            height:700,
            width:1000
          });
            return false;
        }else if(ThiType=='addGroup'){
            art.dialog.prompt('新的分组名称', function (val) {
                YW.ajax({
                  type: 'POST',
                  url: '/c/dept/group/add',
                  data:'name='+val+'&cid='+node.id,
                  mysuccess: function(data){
                      var newNodeData = JSON.parse(data);
                      var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                      treeObj.addNodes(node, newNodeData);
                      alert('添加成功');
                  }
                });
            }, '');
            return false;
        }else if(ThiType=='addUser'){
          art.dialog.open('/v/settings/uc_index_u_add.html?id='+node.id);
        }else if(ThiType=='moveTo'){
            art.dialog.open('/v/settings/uc_set_group.html?did='+node.id);
            return false;
        }else if(ThiType=='editThis'){
            if(node.type=='group'){
              art.dialog.prompt('修改分组', function (val) {
                updateGroup(val);
              }, node.name);
            }else{
              updateDept();
            }
            return false;
        }else if(ThiType=='delThis'){
            art.dialog.confirm('删除后不可恢复，确定要删除吗？', function () {
                delNode();
            },function(){
              //cancel
            },'warning');
            return false;
        }else if(ThiType=='adddept'){
          art.dialog.open('/v/settings/uc_index_d_add.html?cid='+node.id);
        }else{
            return false;
        }
    });

    $('[data-toggle=popover]').popover({
        html:true,
        container:'body',
        placement:'top'
    });
});
function getSearch(val){
  //alert($('.jtree').html())
  var input = val;  //记录输入的商家名
  var tds = $('.jtree>li>a');  //取商家名那一列
  if(tds.length<1){
      //blockAlert(0)
      //art.dialog.tips('搜不到任何数据...','warning')
      return false;
  }else{
    for(var i = 0; i < tds.length; i++){
      var td = $(tds[i]).eq(0);
  //  blockAlert( input +'|'+ td.html() +'|'+ td.parent().html() +'|'+ td.html().indexOf(input))
  //    alert(td.attr('rev').indexOf(input))
      if(td.text().indexOf(input) >= 0){ //如果商家名这列总某行内容不包含输入的商家名
        td.parent().show();
      }else{
        td.parent().hide();  //隐藏这行
      }
    }
  }
}
$(document).on('keyup','.input_search', function(event) {
    //blockAlert(event.keyCode)
    if(event.keyCode==27){
        $('[data-toggle=popover]').popover('hide');return false;
    }
    var Thi=$(this),
    ThiVal=Thi.val();
    if(event.keyCode==13){
        getSearch(ThiVal);
    }
    return false;
});
</script>
<div class="sideHead">
    组织架构
</div>

<table class="table table-nopadding side_table" width="100%">
  <tbody>
    <tr class="list">
      <td>
        <div class="zTreeDemoBackground left">
          <ul id="treeDemo" class="ztree jtree"></ul>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<div class="sideFoot">
  <ul>
    <li>
      <a href="" data-toggle="tooltip" auth="sz_company_add" title="添加公司" class="btns" data-type="add_company"><i class="glyphicon glyphicon-plus"></i>添加公司</a>
      <a href="" title="搜索数据" class="btns" id="search" data-type="popover" data-toggle="popover" data-content='<input type="text" class="form-control input_search" placeholder="公司代码\公司名\等" name="" value="" style="min-width:250px;">' autofocus="autofocus"><i class="glyphicon glyphicon-plus"></i>搜索</a>
    </li>
  </ul>
</div>

<div id="rMenu" class="list-group" style="position:absolute">
  <a href="javascript:void(0)" auth="sz_record_on" id="m_list_records" data-type="seeRecords" class="list-group-item disabled">查看操作记录</a>
  <a href="javascript:void(0)" auth="sz_genjin_on" id="m_list_genjin" data-type="seeGenjin" class="list-group-item">查看跟进</a>
  <a href="javascript:void(0)" auth="sz_group_add" id="m_add_group" data-type="addGroup" class="list-group-item" >添加分组</a>
  <a href="javascript:void(0)" auth="sz_user_add" id="m_add_user" data-type="addUser" class="list-group-item" >添加用户</a>
  <a href="javascript:void(0)" auth="sz_dian_add" id="m_add_dept" data-type="adddept" class="list-group-item" >添加店面</a>
  <a href="javascript:void(0)" auth="sz_group_set" id="m_move_to" data-type="moveTo" class="list-group-item">移动至</a>
  <a href="javascript:void(0)" auth="sz_dian_edit" data-type="editThis" id="m_edit_dept" class="list-group-item">修改店面</a>
  <a href="javascript:void(0)" auth="sz_dian_edit" data-type="editThis" id="m_edit_comp" class="list-group-item">修改公司</a>
  <a href="javascript:void(0)" auth="sz_group_edit" data-type="editThis" id="m_edit_group" class="list-group-item">修改分组</a>
  <a href="javascript:void(0)" auth="sz_dian_del" data-type="delThis" id="m_del_dept" class="list-group-item">删除店面</a>
  <a href="javascript:void(0)" auth="sz_group_del" data-type="delThis" id="m_del_group" class="list-group-item">删除分组</a>
</div>